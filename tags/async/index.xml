<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Async on Blog de Mikkel</title><link>https://tehawol.github.io/LabVeilTech/tags/async/</link><description>Recent content in Async on Blog de Mikkel</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 24 Jan 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://tehawol.github.io/LabVeilTech/tags/async/index.xml" rel="self" type="application/rss+xml"/><item><title>Expérimentation - Gestion de routes asyncrones sur Express</title><link>https://tehawol.github.io/LabVeilTech/posts/experimentation/</link><pubDate>Mon, 24 Jan 2022 00:00:00 +0000</pubDate><guid>https://tehawol.github.io/LabVeilTech/posts/experimentation/</guid><description>Expérimentation - Gestion de routes asyncrones sur Express Asyncrone et Express Dans le framework Node.js, Express, je vais mettre en place un REST API qui retourne divers ressources grâce à des requêtes. Je vais employer du code asyncrone afin de communiquer avec notre base de données hébergé sur un serveur MongoDB externe.
Devant faire face à divers latence ou tout simplement des érreurs, il est important qu&amp;rsquo;un gestion d&amp;rsquo;erreur est en place pour le code asyncrone.</description><content>&lt;h1 id="expérimentation---gestion-de-routes-asyncrones-sur-express">Expérimentation - Gestion de routes asyncrones sur Express&lt;/h1>
&lt;h2 id="asyncrone-et-express">Asyncrone et Express&lt;/h2>
&lt;p>Dans le framework Node.js, Express, je vais mettre en place un REST API qui retourne divers ressources grâce à des requêtes. Je vais employer du code asyncrone afin de communiquer avec notre base de données hébergé sur un serveur MongoDB externe.&lt;/p>
&lt;p>Devant faire face à divers latence ou tout simplement des érreurs, il est important qu&amp;rsquo;un gestion d&amp;rsquo;erreur est en place pour le code asyncrone. Express propose déjà une gestion d’erreur avec son Error Handler qui est accéssible en utilisant lui passant l’erreur grâce à next().&lt;/p>
&lt;h2 id="le-contexte-et-but-de-lexpérimentation">Le contexte et but de l’expérimentation&lt;/h2>
&lt;p>Dans cette expérimentation, je vais implémenter une requête asynconre dans une route Express. Je vais travailler sur l’application Local-Search (&lt;a href="https://github.com/Grolims/ArchiOWeb">GitHub - Grolims/ArchiOWeb: Deploy your REST API on a cloud application platform&lt;/a>), un REST API qui permet à des agriculteurs de partager leur points de ventes et les produits qui y sont disponibles. Les agriculteurs doivent crée un compte qui est associé à tout leurs points de ventes et leurs produits.&lt;/p>
&lt;p>Afin de pouvoir créer un nouveau produit, l’utilisateur et le point de vente associé doit exister. L’expérimentation va être fait sur la route correspondant (création de item) afin de pouvoir comprendre les différentes implémentations et si possible, identifier la solution optimale.&lt;/p>
&lt;h2 id="la-route-initiale">La route initiale&lt;/h2>
&lt;p>Voici la route pour créer un nouveau produit (item).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#75715e">// Vérifie que l&amp;#39;utilisateur existe
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> }); &lt;span style="color:#75715e">// Vérifie que le point de vente existe
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsSalepoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> });
&lt;span style="color:#75715e">// Gestion d&amp;#39;erreur si l&amp;#39;utilisateur existe pas
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsUser&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#75715e">// Gestion d&amp;#39;erreur si le point de vente existe pas
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsSalepoint&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#75715e">// Sauvegarde la nouveau produit et renvoie l&amp;#39;entré à l&amp;#39;utilisateur
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Item&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>);
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>();
&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>);
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Cette implémentation présente plusieurs problèmes, les requêtes sont des opérations asyncrone qui font un appel à la base de données. Pour les gérer correctement dans le code nous devont rendre notre route (plus spécifiquement son callback) asyncrone avec le mot clé &lt;strong>async&lt;/strong>. Les requêtes doivent également être précédé par le mot clé &lt;strong>await&lt;/strong> pour indiquer qu’elles sont asyncrones.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">async&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> });
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsSalepoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> });
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsUser&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsSalepoint&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>();
&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>);
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Le code est à présent exécutable en locale (si la BDD tourne sur notre machine). Comme indiqué dessus, une des contraintes pour la création d&amp;rsquo;un produit est que l&amp;rsquo;utilisateur et le point de vente associé existe. Les deux requêtes présentes s&amp;rsquo;occupent de valider cette existence, en conséquence elles font donc appels à la base de données. Une gestion d&amp;rsquo;erreur est donc cruciale pour gérer les cas de figure ou ces requêtes ne peuvent avoir lieu.&lt;/p>
&lt;h3 id="rappel-sur-les-promesses">Rappel sur les promesses&lt;/h3>
&lt;p>Les requêtes asyncrone sont temporairement des promesses en attendant leur réponse. La réponse donc notre cas va être un booléan si l&amp;rsquo;utilisateur ou le point de vente existe, au contraire un erreur nous est retourné en cas d&amp;rsquo;échec.&lt;/p>
&lt;h2 id="limplémentation-classique">L&amp;rsquo;implémentation classique&lt;/h2>
&lt;p>Nous pouvons implémenter notre route en utilisant une logique avec .then().&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">async&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> })
.&lt;span style="color:#a6e22e">then&lt;/span>(&lt;span style="color:#a6e22e">resp&lt;/span> =&amp;gt; &lt;span style="color:#66d9ef">if&lt;/span>(&lt;span style="color:#a6e22e">resp&lt;/span>){
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
})
.&lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span> =&amp;gt; &lt;span style="color:#a6e22e">next&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>));
&lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> })
.&lt;span style="color:#a6e22e">then&lt;/span>(&lt;span style="color:#a6e22e">resp&lt;/span> =&amp;gt; &lt;span style="color:#66d9ef">if&lt;/span>(&lt;span style="color:#a6e22e">resp&lt;/span>){
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
})
.&lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span> =&amp;gt; &lt;span style="color:#a6e22e">next&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>));
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Item&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>);
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>().&lt;span style="color:#a6e22e">then&lt;/span>(&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>)).&lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span> =&amp;gt; &lt;span style="color:#a6e22e">next&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>));
});
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="verdicte">Verdicte&lt;/h3>
&lt;p>Cette implémentation est pas très accèssible (il arrive que des problèmes d&amp;rsquo;identation surviennent sur des projets commun avec cette solution) et très verbeuse. Il est recommander de plutôt utiliser une try catch afin d&amp;rsquo;améliorer la lisibilité du code et être à jour avec les best practices.&lt;/p>
&lt;h2 id="try--catch">Try &amp;amp; Catch&lt;/h2>
&lt;p>La première solution que j&amp;rsquo;ai implémenté était un Try &amp;amp; Catch. Dans le block Try si la requête ne se résoud pas correctement, un erreur est retourner au catch (d&amp;rsquo;ou le nom) et je le passe à la gestion d&amp;rsquo;erreur d&amp;rsquo;Express en utilisant la fonction next().&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">async&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">try&lt;/span> {
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> });
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsSalepoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#a6e22e">_id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> });
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsUser&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsSalepoint&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Item&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>);
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>();
&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>);
} &lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>) {
&lt;span style="color:#a6e22e">next&lt;/span>(&lt;span style="color:#a6e22e">err&lt;/span>)
}
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Toutes les requêtes asyncrone peuvent être encapsulé par le try catch car un erreur va directement se résoudre dans le catch.&lt;/p>
&lt;p>La fonction next() passe l&amp;rsquo;erreur au gestionnaire d&amp;rsquo;erreur d&amp;rsquo;Express qui vient s&amp;rsquo;ajouter à la fin du stack du middleware. Ce gestionnaire est très basique, il pourrait donc être intéressant d&amp;rsquo;améliorer ceci.&lt;/p>
&lt;h3 id="verdicte-1">Verdicte&lt;/h3>
&lt;p>Cette implémentation est bien plus lisible que l&amp;rsquo;usage de then(). Par contre&lt;/p>
&lt;h2 id="fonction-encapsulante">Fonction Encapsulante&lt;/h2>
&lt;p>Une autre façon décrire le try catch serait avec un fonction asyncrone et un .then()&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, &lt;span style="color:#66d9ef">async&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">async&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> });
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsSalepoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> });
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsUser&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsSalepoint&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Item&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>);
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>();
&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>);
}
&lt;span style="color:#a6e22e">main&lt;/span>().&lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">next&lt;/span>)
});
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Cette implémentation est complète mais il va rapidement devenir ennuyant d&amp;rsquo;écrire tout ce code pour chaque route. En conséquence la fonction peut être utilisé comme un sorte de middleware qui encapsule les parties asyncrones.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#a6e22e">router&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">asyncHandler&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsUser&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">User&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">userId&lt;/span> });
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">existsSalepoint&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">Salepoint&lt;/span>.&lt;span style="color:#a6e22e">countDocuments&lt;/span>({ &lt;span style="color:#ae81ff">_&lt;/span>&lt;span style="color:#a6e22e">id&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>.&lt;span style="color:#a6e22e">salepointId&lt;/span> });
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsUser&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;User ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">if&lt;/span> (&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#a6e22e">existsSalepoint&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">400&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;Salepoint ID missing or invalid&amp;#39;&lt;/span>)
}
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Item&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>.&lt;span style="color:#a6e22e">body&lt;/span>);
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">newItem&lt;/span>.&lt;span style="color:#a6e22e">save&lt;/span>();
&lt;span style="color:#a6e22e">res&lt;/span>.&lt;span style="color:#a6e22e">status&lt;/span>(&lt;span style="color:#ae81ff">201&lt;/span>).&lt;span style="color:#a6e22e">send&lt;/span>(&lt;span style="color:#a6e22e">newItem&lt;/span>);
});
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">asyncHandler&lt;/span> (&lt;span style="color:#a6e22e">callback&lt;/span>) {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">function&lt;/span> (&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>) {
&lt;span style="color:#a6e22e">callback&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>, &lt;span style="color:#a6e22e">next&lt;/span>).&lt;span style="color:#66d9ef">catch&lt;/span>(&lt;span style="color:#a6e22e">next&lt;/span>)
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Comme mentionné avant, si un érreur survient le &lt;strong>catch&lt;/strong> va l&amp;rsquo;attraper et la passer au error handler de Express.&lt;/p>
&lt;h3 id="verdicte-2">Verdicte&lt;/h3>
&lt;p>Cette implémentation est très élégante est légère pour des applications de grande échelle. Il peut être employé comme une sorte d&amp;rsquo;utilitaire pour gérer la majorité de notre code asyncrone dans nos routes. De plus, nous pouvons y ajouter une gestion d&amp;rsquo;erreur plus complet que celui d&amp;rsquo;Express si on le souhaite.&lt;/p>
&lt;h2 id="express-async-handler">Express Async Handler&lt;/h2>
&lt;p>La fonction encapsulante est une implémentation assez répandu qui a donné lieu à plusieurs package qui accomplisent le même fonctionnement. Un exemple est express-async-handler.&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-clike" data-lang="clike">npm install express-async-handler --save
&lt;/code>&lt;/pre>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-jsx" data-lang="jsx">&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">asyncHandler&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">require&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;express-async-handler&amp;#39;&lt;/span>)
&lt;span style="color:#a6e22e">app&lt;/span>.&lt;span style="color:#a6e22e">post&lt;/span>(&lt;span style="color:#e6db74">&amp;#39;/signup&amp;#39;&lt;/span>, &lt;span style="color:#a6e22e">asyncHandler&lt;/span>(&lt;span style="color:#66d9ef">async&lt;/span>(&lt;span style="color:#a6e22e">req&lt;/span>, &lt;span style="color:#a6e22e">res&lt;/span>) =&amp;gt; {
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">firstThing&lt;/span>()
&lt;span style="color:#66d9ef">await&lt;/span> &lt;span style="color:#a6e22e">secondThing&lt;/span>()
}))
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ce package accomplit exactement la même chose que l&amp;rsquo;implémentation précédante en nous évitant de devoir déclarer une fonction. De plus, le package permet d&amp;rsquo;assurer que next() est toujours le dernier arguments dans la pile de middlewares.&lt;/p>
&lt;h3 id="verdicte-3">Verdicte&lt;/h3>
&lt;p>Plus léger et complet que l&amp;rsquo;implémentation fait maison, cette solution est optimale pour gérer tout code asyncrone dans des routes Express. La déclaration non explicite du asyncHandler peut par contre péjorer la compréhension des collaborateurs.&lt;/p>
&lt;h2 id="a-retenir">A retenir&lt;/h2>
&lt;p>Les routes présentants du code asyncrone sur Express peuvent être implémentés de différentes manières qui accomplisent tous la même tâche mais ayant tous leur propre complexité.&lt;/p>
&lt;p>Travaillant surtout sur des gros projets ou du code asyncrone est inévitable dans presque toutes les routes, il devient très avantageux d&amp;rsquo;utiliser un package comme async-handler ou d&amp;rsquo;en déclarer un nous même. Ceci permet aussi aux collaborateurs de contribuer du code uniforme et une compréhension plus complet de l&amp;rsquo;application.&lt;/p>
&lt;p>Mais au final chaque implémentations fontionnent, le choix revient donc au développeur et à ses préférences.&lt;/p>
&lt;h3 id="sources-">Sources :&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.wisdomgeek.com/development/web-development/using-async-await-in-expressjs/">https://www.wisdomgeek.com/development/web-development/using-async-await-in-expressjs/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.npmjs.com/package/express-async-handler">https://www.npmjs.com/package/express-async-handler&lt;/a>&lt;/li>
&lt;/ul></content></item></channel></rss>